name: Tests

on:
  push:
    branches:
      - main
      - 'v*'
  pull_request:

jobs:
  tests:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Install Nix â„
        uses: DeterminateSystems/nix-installer-action@v4

      - name: Link Cachix ğŸ”Œ
        uses: cachix/cachix-action@v12
        with:
          name: '${{ vars.CACHIX_CACHE_NAME }}'
          authToken: '${{ secrets.CACHIX_CACHE_AUTH_TOKEN }}'

      - name: run unit tests ğŸ”¨
        run: nix build .#checks.x86_64-linux.test --print-build-logs

      - name: run linter checks with clippy ğŸ”¨
        run: nix build .#checks.x86_64-linux.lint --print-build-logs

      - name: update rust-sec advisory db before scanning for vulnerabilities
        run: nix flake lock --update-input advisory-db

      - name: audit for reported security problems ğŸ”¨
        run: nix build .#checks.x86_64-linux.audit --print-build-logs

      - name: run integration tests ğŸ“‹
        run: nix develop --command just test-mongodb-versions

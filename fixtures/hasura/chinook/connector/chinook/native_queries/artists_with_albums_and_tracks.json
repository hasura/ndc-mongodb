{
  "name": "artists_with_albums_and_tracks",
  "representation": "collection",
  "inputCollection": "Artist",
  "description": "combines artist, albums, and tracks into a single document per artist - demonstrates array within array",
  "resultDocumentType": "ArtistWithAlbumsAndTracks",
  "objectTypes": {
    "ArtistWithAlbumsAndTracks": {
      "fields": {
        "_id": { "type": { "scalar": "objectId" } },
        "name": { "type": { "scalar": "string" } },
        "albums": { "type": { "arrayOf": { "arrayOf": { "object": "TrackWithAlbumTitle" } } } }
      }
    },
    "TrackWithAlbumTitle": {
      "fields": {
        "track": { "type": { "scalar": "string" } },
        "album": { "type": { "scalar": "string" } }
      }
    }
  },
  "pipeline": [
    {
      "$lookup": {
        "from": "Album",
        "localField": "ArtistId",
        "foreignField": "ArtistId",
        "as": "albums",
        "pipeline": [
          {
            "$lookup": {
              "from": "Track",
              "localField": "AlbumId",
              "foreignField": "AlbumId",
              "let": {
                "albumTitle": "$Title"
              },
              "as": "tracks",
              "pipeline": [
                {
                  "$replaceWith": {
                    "track": "$Name",
                    "album": "$$albumTitle"
                  }
                }
              ]
            }
          }
        ]
      }
    },
    { 
      "$replaceWith": {
        "_id": "$_id",
        "name": "$Name",
        "albums": { "$map": { "input": "$albums", "in": "$$this.tracks" } }
      }
    }
  ]
}


